# 图像编辑器 - 项目架构文档

## 📋 项目概述

一个基于 React + TypeScript + Vite 构建的在线图像编辑器，支持多图层编辑、裁剪、滤镜、绘图、文字添加等功能。采用双层 Canvas 架构，提供流畅的交互体验和强大的编辑能力。

## 🏗️ 技术栈

- **前端框架**: React 18.2.0
- **构建工具**: Vite 5.4.8
- **语言**: TypeScript 5.3.3
- **样式**: Tailwind CSS 3.4.14 + SCSS
- **核心 API**: Canvas API + ImageBitmap API

## 📁 项目结构

```
image-editor-full/C/
├─ public/
│   └─ _redirects                    # Netlify SPA 路由重定向配置
│
├─ src/
│   ├─ pages/
│   │   └─ Editor/                   # 编辑器主页面模块
│   │       ├─ index.tsx            # 编辑器主组件，管理全局状态和历史记录
│   │       ├─ EditorLayout.tsx    # 三栏布局：工具栏 + 画布 + 属性面板
│   │       ├─ CanvasStage.tsx     # 核心画布组件，处理所有交互逻辑
│   │       ├─ ToolSidebar.tsx     # 左侧工具选择栏
│   │       ├─ PropertyPanel.tsx   # 右侧属性配置面板
│   │       ├─ useEditorInit.ts   # 编辑器初始化 Hook（占位）
│   │       └─ editor.scss         # 编辑器样式
│   │
│   ├─ canvas/
│   │   └─ engine/                  # Canvas 渲染引擎核心
│   │       ├─ index.ts             # 引擎入口，导出类型和函数
│   │       ├─ canvas-renderer.ts  # 核心渲染器：图层系统、变换、滤镜
│   │       ├─ image-loader.ts     # 图像加载和 EXIF 处理
│   │       └─ utils/
│   │           ├─ math.ts          # 数学工具函数
│   │           └─ color.ts        # 颜色处理工具
│   │
│   ├─ features/                     # 功能模块（模块化设计）
│   │   ├─ crop/                    # 裁剪功能
│   │   │   ├─ crop.service.ts      # 裁剪核心逻辑
│   │   │   ├─ crop.store.ts       # 裁剪状态管理
│   │   │   └─ CropTool.tsx        # 裁剪工具 UI
│   │   │
│   │   ├─ filter/                  # 滤镜功能
│   │   │   ├─ filter.service.ts    # 滤镜应用逻辑
│   │   │   ├─ filters.ts           # 内置滤镜配置
│   │   │   └─ FilterTool.tsx       # 滤镜工具 UI
│   │   │
│   │   ├─ draw/                    # 绘图功能
│   │   │   ├─ draw.service.ts      # 绘图核心逻辑（笔画处理）
│   │   │   └─ DrawTool.tsx         # 绘图工具 UI
│   │   │
│   │   ├─ text/                    # 文字功能
│   │   │   ├─ text.service.ts      # 文字图层创建和更新
│   │   │   └─ TextTool.tsx         # 文字工具 UI
│   │   │
│   │   └─ history/                 # 历史记录系统
│   │       ├─ history.service.ts   # 撤销/重做服务
│   │       └─ history.store.ts     # 历史记录状态存储
│   │
│   ├─ components/                   # 通用组件
│   │   ├─ ui/                      # 可复用 UI 组件库
│   │   │   ├─ Button.tsx          # 按钮组件
│   │   │   ├─ Slider.tsx          # 滑块组件
│   │   │   ├─ Modal.tsx           # 模态框组件
│   │   │   └─ Tabs.tsx            # 标签页组件
│   │   │
│   │   ├─ ImageUploader.tsx        # 图片上传组件
│   │   ├─ LoadingMask.tsx         # 加载遮罩组件
│   │   └─ Toast.tsx               # 提示消息组件
│   │
│   ├─ services/                     # 业务服务层
│   │   ├─ file.service.ts          # 文件导出服务
│   │   ├─ exif.service.ts          # EXIF 信息读取服务
│   │   └─ compressor.service.ts    # 图片压缩服务
│   │
│   ├─ hooks/                        # 自定义 React Hooks
│   │   ├─ useCanvasResize.ts      # Canvas 尺寸自适应
│   │   ├─ useDrag.ts              # 拖拽交互 Hook
│   │   └─ useKeyPress.ts          # 键盘事件 Hook
│   │
│   ├─ utils/                        # 工具函数
│   │   ├─ debounce.ts             # 防抖函数
│   │   ├─ throttle.ts             # 节流函数
│   │   └─ download.ts             # 文件下载工具
│   │
│   ├─ types/                        # TypeScript 类型定义
│   │   ├─ editor.ts               # 编辑器相关类型
│   │   └─ image.ts                # 图像相关类型
│   │
│   ├─ styles/                       # 全局样式
│   │   ├─ globals.css             # 全局样式入口
│   │   └─ variables.css           # CSS 变量定义
│   │
│   ├─ App.tsx                      # 应用根组件
│   └─ main.tsx                     # 应用入口文件
│
├─ dist/                             # 构建输出目录
├─ index.html                        # HTML 入口文件
├─ vite.config.ts                   # Vite 配置
├─ tsconfig.json                    # TypeScript 配置
├─ tailwind.config.cjs              # Tailwind CSS 配置
├─ postcss.config.cjs               # PostCSS 配置
├─ netlify.toml                     # Netlify 部署配置
└─ package.json                     # 项目依赖配置
```

## 🎯 核心架构设计

### 1. 双层 Canvas 架构

项目采用双层 Canvas 设计，实现渲染与交互的分离：

- **背景层 (Background Canvas)**: 负责渲染所有图像图层和滤镜效果
- **UI 层 (UI Canvas)**: 负责绘制交互元素（裁剪框、控制点、选择框等）

**优势**:
- 交互元素不会影响图像渲染性能
- 可以独立更新 UI 层而不重绘图像
- 支持高 DPI 显示（通过 devicePixelRatio 适配）

### 2. 图层系统 (Layer System)

每个图层是独立的图像单元，支持：

- **位置变换**: `offset` (x, y) - 图层在图像坐标系中的位置
- **缩放变换**: `scale` - 图层缩放比例 (0.1 ~ 5.0)
- **旋转变换**: `rotation` - 图层旋转角度 (0 ~ 360°)
- **可见性**: `visible` - 控制图层显示/隐藏
- **图层类型**: 图像图层、文本图层

**图层坐标系**:
- 图像坐标系：所有图层共享的全局坐标系
- 图层本地坐标系：相对于图层中心的局部坐标系
- 视图坐标系：Canvas 视口的屏幕坐标系

### 3. 状态管理架构

采用分层状态管理：

```
Editor (index.tsx)
  ├─ 全局状态：activeTool, filterState, fileName, layers, activeLayerId
  ├─ 历史记录：history, historyIndex, timeline
  └─ 文本元数据：textLayerMetadata
     │
     └─> CanvasStage (CanvasStage.tsx)
           └─> Renderer (canvas-renderer.ts)
                 └─> Layer State (内部状态)
```

**状态流向**:
1. 用户操作 → Editor 组件
2. Editor 更新状态 → 传递给 CanvasStage
3. CanvasStage 调用 Renderer API → 更新图层
4. Renderer 触发重渲染 → 更新 Canvas

### 4. 历史记录系统

**快照机制**:
- 每个历史记录包含完整的编辑器状态快照
- 快照包含：滤镜状态、所有图层位图（序列化为 dataURL）、视图状态、激活图层索引
- 支持撤销/重做和时间线跳转

**内存管理**:
- 最大历史记录数：40 条
- 最大历史记录体积：25MB（软上限）
- 自动修剪：超出限制时从最旧记录开始删除

**时间线过滤**:
- 仅重要操作显示在时间线（工具切换、手动保存、快捷键保存）
- 所有操作都记录在历史栈中（用于撤销/重做）

## 🔄 核心运行流程

### 1. 应用初始化流程

```
main.tsx
  └─> App.tsx
       └─> Editor (index.tsx)
            └─> EditorLayout
                 ├─> ToolSidebar
                 ├─> CanvasStage (初始化 Renderer)
                 └─> PropertyPanel
```

### 2. 图像加载流程

```
用户选择文件
  └─> ImageUploader 组件
       └─> CanvasStage.handleFileUpload
            └─> Renderer.loadImage
                 ├─> createImageBitmap (创建位图)
                 ├─> 创建 Layer 对象
                 ├─> 添加到 layers 数组
                 ├─> recomputeSize (重新计算图像尺寸)
                 └─> render() (触发渲染)
```

### 3. 工具操作流程

#### 裁剪工具
```
用户选择裁剪工具
  └─> 绘制裁剪框（UI Canvas）
       └─> 用户调整裁剪区域
            └─> 确认裁剪
                 └─> crop.service.cropImage
                      └─> Renderer.applyCrop
                           ├─> 计算裁剪区域（考虑图层变换）
                           ├─> 创建临时 Canvas
                           ├─> 绘制裁剪后的图像
                           ├─> 更新图层位图
                           └─> 重置视图状态
```

#### 滤镜工具
```
用户调整滤镜参数
  └─> Editor.onFilterChange (防抖 1500ms)
       └─> Renderer.setFilter
            └─> 更新 filter 状态
                 └─> render() (应用 CSS filter)
```

#### 绘图工具
```
用户开始绘制
  └─> 记录笔画点数组
       └─> 结束绘制
            └─> draw.service.drawStroke
                 ├─> 坐标转换（世界坐标 → 图层本地坐标）
                 ├─> 创建临时 Canvas
                 ├─> 绘制原始图层 + 笔画
                 ├─> 更新图层位图
                 └─> render()
```

#### 文字工具
```
用户添加文字
  └─> text.service.addTextLayer
       ├─> 创建临时 Canvas
       ├─> 渲染文本为图像
       ├─> 转换为 ImageBitmap
       ├─> 添加到 Renderer
       └─> 保存文本元数据到 textLayerMetadata
```

### 4. 历史记录流程

```
用户执行操作
  └─> Editor.addTimeline
       ├─> createSnapshot (创建状态快照)
       │    ├─> 序列化所有图层位图为 dataURL
       │    ├─> 保存滤镜状态
       │    └─> 保存视图状态
       │
       ├─> 添加到 history 数组
       ├─> 更新 historyIndex
       ├─> 修剪历史记录（数量/体积限制）
       └─> 更新 timeline（过滤显示）

用户撤销/重做
  └─> Editor.handleUndo/handleRedo
       └─> restoreSnapshot
            ├─> 清空现有图层
            ├─> 恢复滤镜状态
            ├─> 按顺序恢复图层（从 dataURL 重建）
            ├─> 恢复视图状态
            └─> 更新所有相关状态
```

### 5. 图层操作流程

```
用户操作图层（移动/缩放/旋转）
  └─> Renderer API (setLayerOffset/setLayerScale/setLayerRotation)
       └─> 更新图层属性
            └─> render() (重新渲染)
                 ├─> 计算图层变换矩阵
                 ├─> 应用变换（translate + rotate + scale）
                 └─> 绘制到背景 Canvas
```

### 6. 导出流程

```
用户点击导出
  └─> file.service.exportImage
       ├─> 计算所有可见图层的边界框（考虑变换）
       ├─> 创建临时 Canvas（尺寸 = 边界框）
       ├─> 应用滤镜效果
       ├─> 绘制所有可见图层（应用变换）
       ├─> 转换为 Blob
       └─> downloadBlob (触发下载)
```

## 🛠️ 关键技术实现

### 1. 坐标变换系统

**三层坐标系转换**:

```typescript
// 视图坐标 → 图像坐标
function viewToImage(viewX: number, viewY: number): Point {
  const { zoom, offset, imgSize, view } = state
  const cx = view.w / 2 + offset.x
  const cy = view.h / 2 + offset.y
  const x = (viewX - cx) / zoom + imgSize.w / 2
  const y = (viewY - cy) / zoom + imgSize.h / 2
  return { x, y }
}

// 图像坐标 → 图层本地坐标（考虑图层变换）
function imageToLayerLocal(imageX: number, imageY: number, layer: Layer): Point {
  const centerX = layer.offset.x + layer.bitmap.width / 2
  const centerY = layer.offset.y + layer.bitmap.height / 2
  const dx = imageX - centerX
  const dy = imageY - centerY
  // 反向旋转
  const rad = (-layer.rotation * Math.PI) / 180
  const cos = Math.cos(rad)
  const sin = Math.sin(rad)
  const rx = dx * cos - dy * sin
  const ry = dx * sin + dy * cos
  // 考虑缩放
  return {
    x: rx / layer.scale + layer.bitmap.width / 2,
    y: ry / layer.scale + layer.bitmap.height / 2
  }
}
```

### 2. 图层渲染变换

```typescript
// 渲染图层时应用变换
bgCtx.save()
bgCtx.translate(viewCenterX, viewCenterY)  // 平移到视图中心
bgCtx.rotate((layer.rotation * Math.PI) / 180)  // 旋转
bgCtx.drawImage(
  layer.bitmap,
  -scaledW / 2, -scaledH / 2,  // 从中心绘制
  scaledW, scaledH  // 缩放后的尺寸
)
bgCtx.restore()
```

### 3. 裁剪算法（考虑图层变换）

裁剪时需要处理：
- 图层在图像坐标系中的位置（offset）
- 图层的缩放和旋转
- 裁剪区域的旋转

```typescript
// 1. 计算裁剪区域在图层本地坐标系中的位置
// 2. 应用图层旋转
// 3. 绘制裁剪区域
// 4. 更新图层位图
```

### 4. 高 DPI 适配

```typescript
const dpr = window.devicePixelRatio || 1
canvas.width = Math.floor(width * dpr)
canvas.height = Math.floor(height * dpr)
canvas.style.width = `${width}px`
canvas.style.height = `${height}px`

// 渲染时应用 DPR 变换
ctx.setTransform(dpr, 0, 0, dpr, 0, 0)
```

### 5. 性能优化策略

- **ImageBitmap API**: 使用 `createImageBitmap` 替代 `Image` 对象，支持异步加载和更好的性能
- **防抖/节流**: 滤镜调整使用防抖（1500ms），避免频繁渲染
- **历史记录限制**: 限制历史记录数量和体积，防止内存溢出
- **按需渲染**: 仅渲染可见图层
- **Canvas 复用**: 使用临时 Canvas 进行图像处理，避免污染主 Canvas

## 📊 数据流图

```
┌─────────────┐
│   User      │
│  Actions    │
└──────┬──────┘
       │
       ▼
┌─────────────┐      ┌──────────────┐      ┌─────────────┐
│   Editor    │─────▶│ CanvasStage  │─────▶│  Renderer   │
│ (State Mgmt)│      │  (Interact)  │      │  (Render)   │
└──────┬──────┘      └──────────────┘      └──────┬──────┘
       │                                            │
       │                                            ▼
       │                                    ┌─────────────┐
       │                                    │   Canvas    │
       │                                    │  (Display)  │
       │                                    └─────────────┘
       │
       ▼
┌─────────────┐
│  History    │
│  (Snapshot) │
└─────────────┘
```

## 🚀 后续规划

### 短期优化（1-2 周）

1. **性能优化**
   - [ ] 实现 Web Workers 处理大图滤镜计算
   - [ ] 优化历史记录序列化（使用 IndexedDB 存储）
   - [ ] 实现图层懒加载（大图分块加载）

2. **功能增强**
   - [ ] 添加更多滤镜效果（模糊、锐化、色调调整）
   - [ ] 支持图层混合模式（正片叠底、叠加等）
   - [ ] 实现图层蒙版功能
   - [ ] 添加形状工具（矩形、圆形、箭头等）

3. **用户体验**
   - [ ] 优化移动端触摸交互
   - [ ] 添加快捷键提示面板
   - [ ] 实现拖拽排序图层列表
   - [ ] 添加撤销/重做可视化指示器

### 中期规划（1-2 月）

1. **高级功能**
   - [ ] 实现 WASM 图像处理（使用 Rust 编写高性能滤镜）
   - [ ] 支持 PSD 文件导入
   - [ ] 实现图层分组功能
   - [ ] 添加动画/关键帧系统

2. **协作功能**
   - [ ] 实现项目保存/加载（JSON 格式）
   - [ ] 支持导出为多种格式（WebP、AVIF）
   - [ ] 添加批量处理功能

3. **插件系统**
   - [ ] 设计插件 API
   - [ ] 支持第三方滤镜插件
   - [ ] 实现自定义工具扩展

### 长期愿景（3-6 月）

1. **架构升级**
   - [ ] 迁移到 WebGPU（替代 Canvas 2D，获得更好性能）
   - [ ] 实现服务端渲染支持（SSR）
   - [ ] 构建 PWA 版本（离线使用）

2. **企业功能**
   - [ ] 用户认证和项目云同步
   - [ ] 团队协作编辑
   - [ ] API 接口开放

3. **AI 集成**
   - [ ] 智能抠图（背景移除）
   - [ ] 图像风格转换
   - [ ] 自动图像增强

## 🔧 开发规范

### 代码组织

- **模块化**: 每个功能模块独立，互不依赖
- **类型安全**: 全面使用 TypeScript，避免 `any` 类型
- **单一职责**: 每个文件/函数只做一件事

### 命名规范

- **组件**: PascalCase (如 `CanvasStage.tsx`)
- **服务**: camelCase (如 `crop.service.ts`)
- **类型**: PascalCase (如 `EditorSnapshot`)
- **常量**: UPPER_SNAKE_CASE (如 `MAX_HISTORY_COUNT`)

### 状态管理

- **本地状态**: 使用 `useState` 管理组件内部状态
- **共享状态**: 通过 Props 传递，避免全局状态
- **历史状态**: 使用快照机制，支持时间旅行

### 性能要求

- **渲染帧率**: 保持 60 FPS
- **内存占用**: 单图不超过 100MB
- **响应时间**: 操作响应 < 100ms

## 📝 注意事项

1. **内存管理**: 
   - 及时调用 `ImageBitmap.close()` 释放内存
   - 历史记录快照会占用大量内存，需要限制

2. **坐标系统**:
   - 注意区分图像坐标系、图层坐标系、视图坐标系
   - 所有变换操作需要考虑图层的 offset、scale、rotation

3. **异步操作**:
   - 图像加载、位图创建都是异步的
   - 使用 `async/await` 处理异步流程

4. **浏览器兼容性**:
   - ImageBitmap API 需要现代浏览器支持
   - Canvas 2D 在所有主流浏览器都支持

## 🎓 学习资源

- [Canvas API 文档](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [ImageBitmap API](https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap)
- [React Hooks 最佳实践](https://react.dev/reference/react)
- [TypeScript 高级类型](https://www.typescriptlang.org/docs/handbook/2/types-from-types.html)

---

**最后更新**: 2024年
**维护者**: 项目团队
